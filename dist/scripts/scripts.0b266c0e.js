"use strict";angular.module("adopcionTecnologicaApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/sankey",{templateUrl:"views/sankey.html",controller:"SankeyCtrl",controllerAs:"sankey"}).when("/pack",{templateUrl:"views/pack.html",controller:"PackCtrl",controllerAs:"pack"}).otherwise({redirectTo:"/"}),b.hashPrefix("")}]).service("TabletopService",["$q","$rootScope",function(a,b){function c(a){return"Yes"==a?!0:!1}function d(a){return 1==parseInt(a)?!0:!1}function e(a){return isNaN(a)?0:parseInt(a)}this.data=!1,this.loading=!1,this.getData=function(){var b=this;return a(function(a,f){b.data?a(angular.copy(b.data)):Tabletop.init({key:"1QPAULewdG_e8bnIVzr2MhnoVQQPKzs6Orry8w8-IHak",callback:function(f,g){b.data=f.map(function(a){return{tech_entrepreneur:c(a.tech_entrepreneur),rcount_adoptdigitech:e(a.rcount_adoptdigitech),rcount_advancetech:e(a.rcount_advancetech),rcount_basictech:e(a.rcount_basictech),adopt_notech:d(a.adopt_notech),adopt_basictech:d(a.adopt_basictech),adopt_advancetech:d(a.adopt_advancetech),adopt_digitech_online:c(a.adopt_digitech_online),adopt_digitech_web:c(a.adopt_digitech_web),adopt_digitech_ecommerce:c(a.adopt_digitech_ecommerce),adopt_digitech_socialmedia:c(a.adopt_digitech_socialmedia),adopt_digitech_erp:c(a.adopt_digitech_erp),adopt_digitech_diseno:c(a.adopt_digitech_diseno),adopt_digitech_crm:c(a.adopt_digitech_crm),adopt_digitech_bigdata:c(a.adopt_digitech_bigdata),adopt_digitech_iot:c(a.adopt_digitech_iot),adopt_digitech_cloud:c(a.adopt_digitech_cloud),adopt_digitech_virtreality:c(a.adopt_digitech_virtreality),adopt_digitech_cogtech:c(a.adopt_digitech_cogtech),adopt_digitech_other:c(a.adopt_digitech_other),adopt_digitech_notsure:c(a.adopt_digitech_notsure),adopt_digitech_none:c(a.adopt_digitech_none)}}),a(angular.copy(b.data))},simpleSheet:!0,parseNumbers:!1})})}}]).run(["$rootScope","$routeParams","$location",function(a,b,c){a.thresdhold={basic:d3.scaleThreshold().domain([0,10,20,30,40,50,60,70,80,90]).range(["#7997ca","#809ccd","#87a1cf","#8ea6d2","#94abd5","#9bb0d7","#a1b5da","#a8bbdd","#afc0df","#b5c5e2"].reverse()),advanced:d3.scaleThreshold().domain([0,10,20,30,40,50,60,70,80,90]).range(["#26754a","#337c52","#3e825b","#498964","#53906d","#5e9775","#689d7e","#72a488","#7cab91","#86b29a"].reverse()),none:d3.scaleThreshold().domain([0,10,20,30,40,50,60,70,80,90]).range(["#9f724e","#a87e5c","#b1896b","#b9957a","#c2a189","#caae98","#d2baa8","#dac7b8","#e2d3c8","#eae0d8"].reverse())},a.legend_colors=d3.scaleOrdinal().domain(["Adopción de tecnología básica","Adopción de tecnología avanzada","Sin adopción"]).range([a.thresdhold.basic(100),a.thresdhold.advanced(100),a.thresdhold.none(100)]),a.tipo_colors=d3.scaleOrdinal().range(["#036633","#698AC6","#956336","#92C14D","#2B3180","#E3117E","#EF830C","#E31F20"]),a.catNames={tech:"Tecnológico",no_tech:"No tecnológico",basic:"Tecnología básica",advanced:"Tecnología avanzada",none:"No adoptó nada"},a.fieldNames={basic:{adopt_digitech_online:"Online",adopt_digitech_web:"Web",adopt_digitech_ecommerce:"Ecommerce",adopt_digitech_socialmedia:"Social Media",adopt_digitech_erp:"ERP",adopt_digitech_diseno:"Diseño",adopt_digitech_crm:"CRM"},advanced:{adopt_digitech_bigdata:"Big Data",adopt_digitech_cloud:"Cloud",adopt_digitech_virtreality:"VR",adopt_digitech_cogtech:"Cogtech",adopt_digitech_other:"Other"},none:{adopt_digitech_notsure:"No estoy seguro",adopt_digitech_none:"Ninguna"}},a.groupResults=function(b,c){var d=d3.nest().key(function(b){return b.tech_entrepreneur?a.catNames.tech:a.catNames.no_tech}).rollup(function(b){var c={};return c[a.catNames.basic]=a.calculateQtyTech(b,"basic"),c[a.catNames.advanced]=a.calculateQtyTech(b,"advanced"),c[a.catNames.none]=a.calculateQtyTech(b,"none"),{total:b.length,type:"company",children:c}}).map(b);if(c){var e=[];return angular.forEach(d,function(a,b){a.name=b.replace("$","");var c=[];angular.forEach(a.children,function(a,b){a.name=b;var d=[];angular.forEach(a.children,function(a,b){a.name=b,d.push(a)}),a.children=d,c.push(a)}),a.children=c,e.push(a)}),e}return d},a.calculateQtyTech=function(b,c){var d=a.fieldNames[c],e={};return angular.forEach(d,function(a,d){var f=_.reduce(b,function(a,b){return a+(1==b[d]?1:0)},0);e[a]={parentType:"level",parentId:c,qty:f,type:"tech"}}),{id:c,children:e,type:"level"}},a.formatProportion=function(a,b){return Math.round(100*a/b)},a.$on("$routeChangeSuccess",function(b,d,e){a.page=c.path()}),a.renderAdopcionLegend=function(){var b=d3.select("#legend-svg").append("svg").attr("height",60).attr("width",250);b.append("g").attr("class","legendOrdinal").attr("transform","translate(10,10)");var c=d3.legendColor().orient("vertical").labelWrap(250).shape("path",d3.symbol().type(d3.symbolCircle).size(70)()).shapePadding(3).scale(a.legend_colors);b.select(".legendOrdinal").call(c)}}]),d3.sankey=function(){function a(){n.forEach(function(a){a.sourceLinks=[],a.targetLinks=[]}),o.forEach(function(a){var b=a.source,c=a.target;"number"==typeof b&&(b=a.source=n[a.source]),"number"==typeof c&&(c=a.target=n[a.target]),b.sourceLinks.push(a),c.targetLinks.push(a)})}function b(){n.forEach(function(a){a.value=Math.max(d3.sum(a.sourceLinks,i),d3.sum(a.targetLinks,i))})}function c(){for(var a,b=n,c=0;b.length;)a=[],b.forEach(function(b){b.x=c,b.dx=k,b.sourceLinks.forEach(function(b){a.push(b.target)})}),b=a,++c;d(c),e((m[0]-k)/(c-1))}function d(a){n.forEach(function(b){b.sourceLinks.length||(b.x=a-1)})}function e(a){n.forEach(function(b){b.x*=a})}function f(a){function b(){var a=d3.min(g,function(a){return(m[1]-(a.length-1)*l)/d3.sum(a,i)});g.forEach(function(b){b.forEach(function(b,c){b.y=c,b.dy=b.value*a})}),o.forEach(function(b){b.dy=b.value*a})}function c(a){function b(a){return h(a.source)*a.value}g.forEach(function(c,d){c.forEach(function(c){if(c.targetLinks.length){var d=d3.sum(c.targetLinks,b)/d3.sum(c.targetLinks,i);c.y+=(d-h(c))*a}})})}function d(a){function b(a){return h(a.target)*a.value}g.slice().reverse().forEach(function(c){c.forEach(function(c){if(c.sourceLinks.length){var d=d3.sum(c.sourceLinks,b)/d3.sum(c.sourceLinks,i);c.y+=(d-h(c))*a}})})}function e(){g.forEach(function(a){var b,c,d,e=0,g=a.length;for(a.sort(f),d=0;g>d;++d)b=a[d],c=e-b.y,c>0&&(b.y+=c),e=b.y+b.dy+l;if(c=e-l-m[1],c>0)for(e=b.y-=c,d=g-2;d>=0;--d)b=a[d],c=b.y+b.dy+l-e,c>0&&(b.y-=c),e=b.y})}function f(a,b){return a.y-b.y}var g=d3.nest().key(function(a){return a.x}).sortKeys(d3.ascending).entries(n).map(function(a){return a.values});b(),e();for(var j=1;a>0;--a)d(j*=.99),e(),c(j),e()}function g(){function a(a,b){return a.source.y-b.source.y}function b(a,b){return a.target.y-b.target.y}n.forEach(function(c){c.sourceLinks.sort(b),c.targetLinks.sort(a)}),n.forEach(function(a){var b=0,c=0;a.sourceLinks.forEach(function(a){a.sy=b,b+=a.dy}),a.targetLinks.forEach(function(a){a.ty=c,c+=a.dy})})}function h(a){return a.y+a.dy/2}function i(a){return a.value}var j={},k=40,l=8,m=[10,10],n=[],o=[];return j.nodeWidth=function(a){return arguments.length?(k=+a,j):k},j.nodePadding=function(a){return arguments.length?(l=+a,j):l},j.nodes=function(a){return arguments.length?(n=a,j):n},j.links=function(a){return arguments.length?(o=a,j):o},j.size=function(a){return arguments.length?(m=a,j):m},j.layout=function(d){return a(),b(),c(),f(d),g(),j},j.relayout=function(){return g(),j},j.link=function(){function a(a){var c=a.source.x+a.source.dx,d=a.target.x,e=d3.interpolateNumber(c,d),f=e(b),g=e(1-b),h=a.source.y+a.sy+a.dy/2,i=a.target.y+a.ty+a.dy/2;return"M"+c+","+h+"C"+f+","+h+" "+g+","+i+" "+d+","+i}var b=.5;return a.curvature=function(c){return arguments.length?(b=+c,a):b},a},j},angular.module("adopcionTecnologicaApp").controller("MainCtrl",["TabletopService","$scope","$rootScope",function(a,b,c){b.rawdata=[],c.loading=!0,a.getData().then(function(a){b.rawdata=a,b.totales=c.groupResults(a,!0),$(function(){$('[data-toggle="tooltip"]').tooltip(),setTimeout(function(){$(".has-tooltip").first().tooltip("show")},2e3)}),c.loading=!1})}]),angular.module("adopcionTecnologicaApp").controller("SankeyCtrl",["TabletopService","$scope","$rootScope",function(a,b,c){function d(){function a(){function a(a,c,d){var e=b.fieldNames[c],f={},g=0;return angular.forEach(e,function(b,c){var d=_.reduce(a,function(a,b){return a+(1==b[c]?1:0)},0);g+=d,f[b]={qty:d,type:"tech"}}),{qty:g,children:f,type:"level"}}function c(a,b){g[a]={type:b.type}}var d={nodes:[],links:[]},e=[],f=d3.nest().key(function(a){return a.tech_entrepreneur?b.catNames.tech:b.catNames.no_tech}).rollup(function(c){var d=c.filter(function(a){return a.rcount_basictech>0}),e=_.reduce(b.rawdata,function(a,b){return a+(b.rcount_basictech>0?1:0)},0),f=c.filter(function(a){return a.rcount_advancetech>0}),g=_.reduce(b.rawdata,function(a,b){return a+(b.rcount_advancetech>0?1:0)},0),h=c.filter(function(a){return 1==a.adopt_notech}),i=_.reduce(b.rawdata,function(a,b){return a+(1==b.adopt_notech?1:0)},0),j={};return j[b.catNames.advanced]=a(f,"advanced",g),j[b.catNames.basic]=a(d,"basic",e),j[b.catNames.none]=a(h,"none",i),{qty:c.length,type:"company",children:j}}).map(b.rawdata),g={};_.each(f,function(a,b){b=b.replace("$",""),c(b,a),_.each(a.children,function(a,d){d=d.replace("$",""),c(d,a),e.push({source:b,target:d,value:a.qty,type:a.type}),_.each(a.children,function(a,b){b=b.replace("$",""),c(b,a),e.push({source:d,target:b,value:a.qty,type:a.type})})})});var h={};return e.forEach(function(a){var b=a.source.replace("$",""),c=a.target.replace("$","");d.nodes.push({name:b}),d.nodes.push({name:c}),h[b+"|"+c]||(h[b+"|"+c]={source:b,target:c,value:0}),h[b+"|"+c].value+=a.value}),_.forOwn(h,function(a,b){d.links.push(a)}),d.nodes=d3.keys(d3.nest().key(function(a){return a.name}).map(d.nodes)),d.nodes=d.nodes.filter(function(a){return 0==a.indexOf("$")?!0:!1}).map(function(a){return a.replace("$","")}),d.links.forEach(function(a,b){d.links[b].source=d.nodes.indexOf(d.links[b].source),d.links[b].target=d.nodes.indexOf(d.links[b].target)}),d.nodes.forEach(function(a,b){d.nodes[b]={"node:":b,name:a,data:g[a]}}),d}e.w=d3.select("#sankey-chart-container").node().getBoundingClientRect().width,e.w=!e.svg||e.w<500?e.w:e.w,e.h=700,e.margin=100,e.svg||(e.svg=d3.select("#sankey-chart-container").append("svg"),e.mainGroup=e.svg.append("g").classed("main-group",!0),e.mainGroup.append("rect").attr("fill","white")),e.svg.attr("width",e.w).attr("height",e.h+10),e.mainGroup.select("rect").attr("width",e.w).attr("height",e.h),e.sankey=d3.sankey().nodeWidth(20).nodePadding(2).size([e.w,e.h]),e.path=e.sankey.link(),e.graph=a(),e.sankey.nodes(e.graph.nodes).links(e.graph.links).layout(32),e.link=e.mainGroup.selectAll(".link").data(e.graph.links).enter().append("path").attr("class","link").attr("d",e.path).style("stroke-width",function(a){return Math.max(1,a.dy)}).style("stroke",function(a){return b.tipo_colors.domain().indexOf(a.source.name)>-1?b.tipo_colors(a.source.name):b.tipo_colors(a.target.name)}).sort(function(a,b){return b.dy-a.dy}),e.link.append("title").text(function(a){var b=a.source.name;return console.log(a),b+" → "+a.target.name}),e.node=e.mainGroup.selectAll(".node").data(e.graph.nodes).enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),e.node.append("rect").attr("height",function(a){return a.dy}).attr("width",e.sankey.nodeWidth()).style("fill",function(a){return b.tipo_colors.domain().indexOf(a.name)>-1?b.tipo_colors(a.name):"#000"}).append("title").text(function(a){var b=a.name;return b}),e.node.append("text").attr("y",function(a){return a.dy/2}).attr("x",function(a){return"company"!=a.data.type?-3:3+e.sankey.nodeWidth()}).attr("text-anchor",function(a){return"company"!=a.data.type?"end":"start"}).attr("dy",".35em").attr("transform",null).style("font-size",function(a){return isNaN(a.name)?"14px":"10px"}).text(function(a){return a.name}).filter(function(a){return a.x<e.width/2})}c.loading=!0,a.getData().then(function(a){c.loading=!1,b.rawdata=a,d()});var e={}}]),angular.module("adopcionTecnologicaApp").controller("PackCtrl",["TabletopService","$scope","$rootScope","$timeout",function(a,b,c,d){function e(a,e){g={},g.container=d3.select("#"+a),b.size=g.container.node().getBoundingClientRect().width,g.mainGroup=g.container.append("svg").attr("width",b.size).attr("height",b.size).append("g").attr("id","main").style("transform","translate(0%,-15%)");var h=d3.pack().size([b.size,b.size]).padding(3),i=d3.hierarchy({type:"root",name:a,children:e}).sum(function(a){return a.qty}).sort(function(a,b){return b.qty-a.qty});b.nodes=h(i),b.selectedType=c.catNames.no_tech,d(function(){f(b.selectedType)},1e3)}function f(a){console.log("draw",a);var d=angular.copy(b.nodes);d.children=d.children.filter(function(b){return b.data.name==a}).sort(function(a,b){return a.data.name>b.data.name?1:-1});var e=g.mainGroup.selectAll("g.node").data(d.descendants());e.exit().remove(),e.enter().append("g").attr("class",function(a){return a.children?"node":"leaf node"}).each(function(){var a=d3.select(this);a.append("circle"),a.append("text").style("fill",function(a){return"black"}).style("text-anchor",function(a){return"middle"})}),g.mainGroup.selectAll("g.node").transition().ease(d3.easeElastic).duration(2e3).delay(function(a,b){return 50*b}).attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),g.mainGroup.selectAll("g.node").select("circle").transition().ease(d3.easeElastic).duration(2e3).delay(function(a,b){return 50*b}).style("fill",function(a){return"level"==a.data.parentType?c.thresdhold[a.data.parentId](a.data.qty):"none"}).style("stroke",function(a){var b="";switch(a.data.type){case"company":b="gray";break;case"level":b=c.thresdhold[a.data.id](100);break;case"tech":b=c.thresdhold[a.data.parentId](a.data.qty);break;case"root":b="none"}return b}).style("stroke-width",function(a){var b=0;switch(a.data.type){case"company":case"level":b=1;break;case"tech":b=2;break;case"root":}return b}).attr("r",function(a){return a.r}),g.mainGroup.selectAll("g.node").select("text").text(function(a){return["root","level"].indexOf(a.data.type)>-1?"":a.data.name}).transition().ease(d3.easeElastic).duration(2e3).delay(function(a,b){return 50*b}).attr("transform",function(a){var b="";switch(a.data.type){case"tech":b="translate(0,5)";break;case"level":b="translate(0,"+(a.r+15)+")";break;case"company":b="translate(0,"+(-1*a.r-5)+")"}return b}).on("end",function(a,c,d){c==d.length-1&&(b.selectedTypeLegend=angular.copy(b.selectedType),b.$apply(),d3.select("#pack-legends").classed("show",!0))})}c.loading=!0,b.nodes=[],a.getData().then(function(a){c.loading=!1,b.totales=c.groupResults(a,!0),b.totales_labels=angular.copy(b.totales).reverse(),console.log("TOTAL!",b.total),e("pack-chart-container",b.totales),c.renderAdopcionLegend()}),b.changeType=function(){console.log("change",b.selectedType),d3.select("#pack-legends").classed("show",!1),f(b.selectedType)};var g={}}]),angular.module("adopcionTecnologicaApp").run(["$templateCache",function(a){a.put("views/main.html",'<div id="main"> <div class="row" ng-show="!loading"> <div class="col-md-4"> <div class="jumbotron text-center"> <h1><span ng-if="!loading">{{rawdata.length}}</span><span ng-if="loading">...</span></h1> <p>TOTAL EMPRENDIMIENTOS</p> </div> <h3 class="text-center">Presentado por:</h3> <img class="img-responsive" src="images/logo.bec69dfc.png"> </div> <div class="col-md-4" ng-repeat="(ixc,company) in totales"> <div class="jumbotron"> <h1 class="text-center"><span ng-if="!loading">{{company.total}}</span><span ng-if="loading">...</span></h1> <p class="text-center">{{company.name}}</p> <div ng-repeat="(ixl,level) in company.children"> <span class="level-title" ng-style="{\'border-color\':thresdhold[level.id](100)}">{{level.name}}</span> <ol> <li class="qty-item" ng-repeat="(ixt,tech) in level.children | orderBy:\'-qty\' "> {{tech.name}}<span ng-style="{\'background-color\':thresdhold[level.id](tech.qty)}" class="label pull-right has-tooltip" data-toggle="tooltip" data-placement="left" title="{{tech.qty}} emprendimientos de {{company.total}} \'{{company.name}}\' adoptaron \'{{tech.name}}\'">{{formatProportion(tech.qty,company.total)}}%</span> </li> </ol> </div> </div> </div> </div> </div>'),a.put("views/pack.html",'<div class="row"> <div class="col-sm-10 col-sm-offset-1"> <h1>Volumen de adopción tecnológica</h1> <p class="lead">Seleccione el tipo de emprendimiento para visualizar el volumen de cada categoría y nivel de adopción tecnológica sobre el total.</p> </div> </div> <hr> <div class="row"> <div class="col-sm-10 col-sm-offset-1"> <div id="legend-svg"></div> <form class="form-inline" ng-show="!loading"> <div class="form-group"> <label for="exampleInputName2">Tipo de emprendimiento</label> <select name="type" class="form-control" ng-model="selectedType" ng-change="changeType()"> <option value="{{catNames.no_tech}}">{{catNames.no_tech}}</option> <option value="{{catNames.tech}}">{{catNames.tech}}</option> </select> </div> </form> </div> </div> <div class="row"> <div class="col-sm-10 col-sm-offset-1"> <div id="pack-chart-container"></div> </div> <div id="pack-legends"> <div class="col-md-4 col-md-offset-{{ixc+1}}" ng-repeat="(ixc,company) in totales_labels" ng-if="!loading"> <div class="jumbotron" ng-show="company.name == selectedTypeLegend"> <h3 class="text-center">{{company.name}}</h3> <div ng-repeat="(ixl,level) in company.children"> <span class="level-title" ng-style="{\'border-color\':thresdhold[level.id](100)}">{{level.name}}</span> <ol> <li class="qty-item" ng-repeat="(ixt,tech) in level.children | orderBy:\'-qty\' "> {{tech.name}}<span ng-style="{\'background-color\':thresdhold[level.id](tech.qty)}" class="label pull-right">{{formatProportion(tech.qty,company.total)}}%</span> </li> </ol> </div> </div> </div> </div> </div>'),a.put("views/sankey.html",'<div class="row" ng-show="!loading"> <div class="col-sm-4"> <p><strong>Tipo de emprendimiento</strong></p> </div> <div class="col-sm-4"> <p class="text-center"><strong>Nivel tecnológico adoptado</strong></p> </div> <div class="col-sm-4"> <p class="text-right"><strong>Tecnología adoptada</strong></p> </div> </div> <div class="row"> <div class="col-sm-12"> <div id="sankey-chart-container"></div> </div> </div>')}]);